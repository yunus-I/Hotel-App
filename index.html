<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grand Hotel Guest Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #efeff3;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .active-nav {
            color: var(--tg-theme-button-color);
        }

        .category-pill.active {
            background-color: var(--tg-theme-button-color);
            color: white;
        }

        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Smooth tab transitions */
        .section-fade {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hide scrollbars */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <!-- Header Area -->
    <div id="header" class="p-6 pb-2">
        <h1 id="welcome-text" class="text-2xl font-bold italic tracking-tight text-gray-800">Grand Hotel</h1>
        <p class="text-sm text-gray-500" id="user-status">Welcome to your stay</p>
    </div>

    <!-- Main Content Containers -->
    <main id="app-content" class="px-4 mt-4">
        
        <!-- SECTION: FOOD MENU -->
        <section id="menu-section" class="section-fade">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Room Service</h2>
                <div class="relative" onclick="toggleCart()">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
                </div>
            </div>
            
            <!-- Food Categories -->
            <div id="food-categories" class="flex space-x-2 overflow-x-auto pb-4 mb-2">
                <button class="category-pill active px-4 py-1.5 rounded-full text-sm font-medium border whitespace-nowrap" onclick="filterFood('All')">All</button>
            </div>

            <!-- Food Items Grid -->
            <div id="food-list" class="grid grid-cols-1 gap-4">
                <!-- Skeleton Loader -->
                <div class="animate-pulse flex space-x-4 p-4 bg-gray-50 rounded-xl">
                    <div class="bg-gray-200 h-16 w-16 rounded-lg"></div>
                    <div class="flex-1 space-y-2 py-1">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: ROOMS -->
        <section id="rooms-section" class="section-fade hidden">
            <h2 class="text-xl font-bold mb-4">Discover Our Suites</h2>
            <div id="rooms-list" class="space-y-6">
                <!-- Rooms will be injected here -->
            </div>
        </section>

        <!-- SECTION: SERVICES -->
        <section id="services-section" class="section-fade hidden">
            <h2 class="text-xl font-bold mb-4">Hotel Services</h2>
            <div id="services-grid" class="grid grid-cols-2 gap-4">
                <!-- Services will be injected here -->
            </div>
        </section>

        <!-- SECTION: PROFILE / ORDERS -->
        <section id="profile-section" class="section-fade hidden">
            <h2 class="text-xl font-bold mb-4">My Stay</h2>
            <div class="bg-blue-50 p-4 rounded-2xl mb-6">
                <p class="text-xs text-blue-600 font-bold uppercase mb-1">Active Booking</p>
                <h3 class="font-bold text-lg">Room #402 â€” Deluxe King</h3>
                <p class="text-sm text-gray-600">Check-out: Friday, 11:00 AM</p>
            </div>
            <h3 class="font-bold mb-3">Order History</h3>
            <div id="orders-list" class="text-center py-8 text-gray-400 italic text-sm">
                No active orders found.
            </div>
        </section>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="glass-nav fixed bottom-0 left-0 right-0 h-20 flex items-center justify-around px-6 z-50">
        <button onclick="navigate('menu')" id="nav-menu" class="flex flex-col items-center space-y-1 active-nav">
            <i data-lucide="utensils" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Dining</span>
        </button>
        <button onclick="navigate('rooms')" id="nav-rooms" class="flex flex-col items-center space-y-1 text-gray-400">
            <i data-lucide="bed-double" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Rooms</span>
        </button>
        <button onclick="navigate('services')" id="nav-services" class="flex flex-col items-center space-y-1 text-gray-400">
            <i data-lucide="concierge-bell" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Services</span>
        </button>
        <button onclick="navigate('profile')" id="nav-profile" class="flex flex-col items-center space-y-1 text-gray-400">
            <i data-lucide="user" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">My Stay</span>
        </button>
    </nav>

    <!-- Modal for Cart -->
    <div id="cart-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-3xl p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Your Tray</h3>
                <button onclick="toggleCart()" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="cart-items" class="space-y-4 mb-6">
                <!-- Cart items inject here -->
            </div>
            <div class="border-t pt-4">
                <div class="flex justify-between font-bold text-lg mb-4">
                    <span>Total</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <button onclick="checkout()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Confirm Order</button>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "", // Automatically handled by environment
            authDomain: "telegram-hotel-app.firebaseapp.com",
            projectId: "telegram-hotel-app",
            storageBucket: "telegram-hotel-app.firebasestorage.app",
            messagingSenderId: "598463870857",
            appId: "1:598463870857:web:86f6713e31e506e78864d4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const hotelID = "hotel_001";

        // 2. App State
        let currentTab = 'menu';
        let foodData = [];
        let roomData = [];
        let serviceData = [];
        let cart = [];
        let currentFoodCategory = 'All';

        // Initialize Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 3. Navigation Logic
        function navigate(tab) {
            currentTab = tab;
            
            // Hide all sections
            ['menu-section', 'rooms-section', 'services-section', 'profile-section'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Show active section
            document.getElementById(`${tab}-section`).classList.remove('hidden');

            // Update Nav Icons
            ['nav-menu', 'nav-rooms', 'nav-services', 'nav-profile'].forEach(id => {
                document.getElementById(id).classList.remove('active-nav');
                document.getElementById(id).classList.add('text-gray-400');
            });
            document.getElementById(`nav-${tab}`).classList.add('active-nav');
            document.getElementById(`nav-${tab}`).classList.remove('text-gray-400');

            // Set Header Title based on tab
            const headerTitles = {
                menu: 'Room Service',
                rooms: 'The Suites',
                services: 'Amenities',
                profile: 'Guest Portal'
            };
            document.getElementById('welcome-text').innerText = headerTitles[tab];
        }

        // 4. Data Fetching (Real-time)
        function initData() {
            // Fetch Menu
            db.collection('hotels').doc(hotelID).collection('food').onSnapshot(snap => {
                foodData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
                renderFood();
            });

            // Fetch Rooms
            db.collection('hotels').doc(hotelID).collection('rooms').onSnapshot(snap => {
                roomData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRooms();
            });

            // Fetch Services
            db.collection('hotels').doc(hotelID).collection('services').onSnapshot(snap => {
                serviceData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderServices();
            });
        }

        // 5. Rendering Logic
        function renderCategories() {
            const container = document.getElementById('food-categories');
            const categories = ['All', ...new Set(foodData.map(item => item.category))];
            
            container.innerHTML = categories.map(cat => `
                <button class="category-pill ${currentFoodCategory === cat ? 'active' : ''} px-4 py-1.5 rounded-full text-sm font-medium border whitespace-nowrap" 
                        onclick="filterFood('${cat}')">${cat}</button>
            `).join('');
        }

        function filterFood(cat) {
            currentFoodCategory = cat;
            renderCategories();
            renderFood();
        }

        function renderFood() {
            const container = document.getElementById('food-list');
            const filtered = currentFoodCategory === 'All' ? foodData : foodData.filter(i => i.category === currentFoodCategory);

            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-center py-10 text-gray-400 italic">No items available in this category.</p>`;
                return;
            }

            container.innerHTML = filtered.map(item => `
                <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-2xl border border-gray-100 card-shadow transition-transform active:scale-[0.98]">
                    <div class="bg-blue-100 text-blue-600 h-16 w-16 rounded-xl flex items-center justify-center font-bold text-xl">
                        ${item.name.charAt(0)}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${item.name}</h4>
                        <div class="flex items-center text-xs text-gray-500 mt-1">
                            <i data-lucide="clock" class="w-3 h-3 mr-1"></i> ${item.time || '15'} mins
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600 mb-2">$${Number(item.price).toFixed(2)}</p>
                        <button onclick="addToCart('${item.id}')" class="bg-white border border-blue-200 text-blue-600 p-1.5 rounded-lg hover:bg-blue-600 hover:text-white">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderRooms() {
            const container = document.getElementById('rooms-list');
            container.innerHTML = roomData.map(room => `
                <div class="overflow-hidden bg-white rounded-3xl border border-gray-100 card-shadow">
                    <div class="h-48 bg-gray-200 flex items-center justify-center relative">
                        <i data-lucide="image" class="w-12 h-12 text-gray-300"></i>
                        <div class="absolute top-4 right-4 bg-white/90 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                            ${room.available ? 'ðŸŸ¢ Available' : 'ðŸ”´ Occupied'}
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${room.type}</h3>
                            <span class="text-blue-600 font-bold">$${room.price}<span class="text-xs text-gray-400 font-normal">/night</span></span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">${room.description || 'Spacious room with modern amenities and luxury finishes.'}</p>
                        <div class="flex items-center space-x-4 mb-6 text-gray-400">
                            <div class="flex items-center text-xs"><i data-lucide="users" class="w-4 h-4 mr-1"></i> ${room.maxGuests || 2} Guests</div>
                            <div class="flex items-center text-xs"><i data-lucide="wifi" class="w-4 h-4 mr-1"></i> Free Wi-Fi</div>
                        </div>
                        <button class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md shadow-blue-100" 
                                onclick="tg.MainButton.setText('Book ${room.type}'); tg.MainButton.show();">
                            View Details
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderServices() {
            const container = document.getElementById('services-grid');
            container.innerHTML = serviceData.map(svc => `
                <div class="p-5 bg-white border border-gray-50 rounded-2xl flex flex-col items-center text-center card-shadow active:bg-blue-50 transition-colors">
                    <div class="bg-blue-50 p-4 rounded-full text-blue-600 mb-3">
                        <i data-lucide="${svc.icon || 'star'}" class="w-8 h-8"></i>
                    </div>
                    <h4 class="font-bold text-sm mb-1">${svc.title}</h4>
                    <p class="text-[10px] text-gray-400">${svc.category || 'Guest Service'}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // 6. Cart Management
        function addToCart(id) {
            const item = foodData.find(f => f.id === id);
            const exists = cart.find(c => c.id === id);
            if (exists) {
                exists.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            updateCartUI();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function updateCartUI() {
            const count = cart.reduce((acc, item) => acc + item.quantity, 0);
            const badge = document.getElementById('cart-count');
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);

            const itemsContainer = document.getElementById('cart-items');
            if (cart.length === 0) {
                itemsContainer.innerHTML = `<p class="text-center py-6 text-gray-400 italic">Your tray is empty.</p>`;
                document.getElementById('cart-total').innerText = "$0.00";
            } else {
                itemsContainer.innerHTML = cart.map(item => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <div>
                            <h5 class="font-bold text-sm">${item.name}</h5>
                            <p class="text-xs text-blue-600">$${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="changeQty('${item.id}', -1)" class="p-1 bg-white border rounded-md"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span class="font-bold text-sm">${item.quantity}</span>
                            <button onclick="changeQty('${item.id}', 1)" class="p-1 bg-white border rounded-md"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('');
                
                const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
            }
            lucide.createIcons();
        }

        function changeQty(id, delta) {
            const index = cart.findIndex(c => c.id === id);
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            updateCartUI();
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            modal.classList.toggle('hidden');
        }

        function checkout() {
            if (cart.length === 0) return;
            tg.showConfirm("Proceed with your room service order?", (ok) => {
                if (ok) {
                    tg.MainButton.setText("Sending Order...");
                    tg.MainButton.show();
                    // In a real app, you would send this to a 'orders' collection in Firestore
                    setTimeout(() => {
                        cart = [];
                        updateCartUI();
                        toggleCart();
                        tg.MainButton.hide();
                        tg.showAlert("âœ… Order Received! We'll deliver it to Room #402 shortly.");
                    }, 1500);
                }
            });
        }

        // Initialize Everything
        window.onload = () => {
            initData();
            lucide.createIcons();
            // Handle Telegram user data
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                document.getElementById('user-status').innerText = `Guest: ${tg.initDataUnsafe.user.first_name}`;
            }
        };

    </script>
</body>
</html>